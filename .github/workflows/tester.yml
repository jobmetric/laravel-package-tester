name: Tester

on:
  workflow_call:
    inputs:
      php-version:
        description: PHP version.
        required: false
        default: "8.2"
        type: string
      laravel-version:
        description: Laravel version for sandbox app.
        required: false
        default: "^9.0"
        type: string
      date_format:
        description: "Date format"
        required: false
        type: string
      calendar_type:
        description: "Calendar type"
        required: false
        type: string
        default: "jalali"
      timezone:
        description: "Timezone"
        required: false
        type: string
        default: "UTC"
      package-name:
        description: "Package name to test (e.g., jobmetric/laravel-env-modifier). If not provided, will be read from composer.json"
        required: false
        type: string
    secrets:
      bot_token:
        description: "Telegram bot token created via BotFather"
        required: false
      chat_id:
        description: "Target Telegram chat ID (user, group, or channel)"
        required: false

permissions:
  contents: read

jobs:
  tests:
    name: PR Package Test (PHP ${{ inputs.php-version }})
    runs-on: ubuntu-latest
    env:
      APP_DIR: .ci/laravel-app
      PACKAGE_DIR: package-under-test
      TESTER_PACKAGE: jobmetric/laravel-package-tester
      TARGET_PACKAGE_VERSION: "@dev"
      COMPOSER_AUDIT: false
    steps:
      - name: Checkout PR package repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.PACKAGE_DIR }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          tools: composer:v2
          coverage: none
          extensions: ${{ inputs.date_format != '' && inputs.date_format != null && 'intl' || '' }}

      - name: Resolve package name
        id: package
        run: |
          set -euo pipefail

          if [ -n "${{ inputs.package-name }}" ]; then
            package_name="${{ inputs.package-name }}"
          else
            composer_file="${PACKAGE_DIR}/composer.json"
            if [ ! -f "$composer_file" ]; then
              echo "composer.json was not found at ${composer_file}" >&2
              exit 1
            fi

            package_name=$(php -r '$data = json_decode(file_get_contents($argv[1]), true); if (!is_array($data) || empty($data["name"])) {fwrite(STDERR, "composer.json does not include a valid name.\n"); exit(1);} echo $data["name"];' "$composer_file")
          fi

          echo "name=${package_name}" >> "$GITHUB_OUTPUT"

      - name: Create sandbox and install packages
        env:
          COMPOSER_AUDIT: false
        run: |
          set -euo pipefail

          composer config --global audit.block-insecure false
          rm -rf "$APP_DIR"
          composer create-project laravel/laravel "$APP_DIR" "${{ inputs.laravel-version }}" --no-interaction --prefer-dist
          cd "$APP_DIR"

          composer config --no-interaction minimum-stability dev
          composer config --no-interaction prefer-stable true
          composer config --no-interaction allow-plugins.jobmetric/package-tester-composer-plugin true
          composer config --no-interaction audit.block-insecure false
          
          composer config --json --no-interaction repositories.package_under_test "{\"type\":\"path\",\"url\":\"${GITHUB_WORKSPACE}/${PACKAGE_DIR}\",\"options\":{\"symlink\":false}}"
          
          # Determine orchestra/testbench version based on Laravel version
          LARAVEL_VERSION="${{ inputs.laravel-version }}"
          # Extract major version number (e.g., "9" from "^9.0" or "10" from "^10.0")
          LARAVEL_MAJOR=$(echo "$LARAVEL_VERSION" | grep -oE '[0-9]+' | head -1)
          
          if [ -z "$LARAVEL_MAJOR" ]; then
            LARAVEL_MAJOR=9
          fi
          
          if [ "$LARAVEL_MAJOR" -ge 12 ]; then
            TESTBENCH_VERSION="^10.0"
          elif [ "$LARAVEL_MAJOR" -ge 11 ]; then
            TESTBENCH_VERSION="^9.0"
          elif [ "$LARAVEL_MAJOR" -ge 10 ]; then
            TESTBENCH_VERSION="^8.0"
          else
            # Default to ^7.0 for Laravel 9 and below
            TESTBENCH_VERSION="^7.0"
          fi
          
          # Install orchestra/testbench first to ensure it's available for package tests
          composer require --dev --no-interaction --no-update "orchestra/testbench:${TESTBENCH_VERSION}" || echo "Warning: Could not add orchestra/testbench, continuing..."
          
          if [ "${{ steps.package.outputs.name }}" != "jobmetric/laravel-package-tester" ]; then
            composer require --no-interaction --no-update "$TESTER_PACKAGE:dev-master" || echo "Warning: Could not add tester package, continuing..."
          fi

          composer require --dev --no-interaction -w "${{ steps.package.outputs.name }}:@dev"
          
          # Install multi-calendar package if date_format is provided (for date conversion script)
          if [ -n "${{ inputs.date_format }}" ] && [ "${{ inputs.date_format }}" != "" ]; then
            composer require --no-interaction --no-update "jobmetric/multi-calendar" || echo "Warning: Could not add multi-calendar package, continuing..."
          fi

          composer update --no-interaction --prefer-dist --with-all-dependencies
          composer dump-autoload --no-interaction  -o

      - name: Prepare Laravel application
        working-directory: ${{ env.APP_DIR }}
        run: |
          set -euo pipefail

          if [ ! -f .env ] && [ -f .env.example ]; then
            cp .env.example .env
          fi

          php artisan key:generate --force

      - name: Run package tests with laravel-package-tester
        id: package_tests
        continue-on-error: true
        working-directory: ${{ env.APP_DIR }}
        run: |
          set -euo pipefail

          php artisan test-run "${{ steps.package.outputs.name }}" --detailed

      - name: Find Date Converter Script
        if: ${{ inputs.date_format != '' && inputs.date_format != null }}
        id: find_script
        run: |
          SCRIPT_PATH="vendor/jobmetric/multi-calendar/bin/date-converter.sh"
          
          if [ -f "$SCRIPT_PATH" ]; then
            chmod +x "$SCRIPT_PATH"
            echo "script_path=$SCRIPT_PATH" >> $GITHUB_OUTPUT
          else
            echo "Warning: date-converter.sh not found at $SCRIPT_PATH. Date conversion will be skipped."
            echo "script_path=" >> $GITHUB_OUTPUT
          fi

      - name: Notify Telegram on failure
        if: ${{ always() && steps.package_tests.outcome == 'failure' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.bot_token }}
          TELEGRAM_CHAT_ID: ${{ secrets.chat_id }}
          PACKAGE_NAME: ${{ steps.package.outputs.name }}
          REPOSITORY: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EVENT_NAME: ${{ github.event_name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          DATE_FORMAT: ${{ inputs.date_format }}
          CALENDAR_TYPE: ${{ inputs.calendar_type }}
          TIMEZONE: ${{ inputs.timezone }}
        shell: bash
        run: |
          # Skip if credentials not set
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram credentials not set. Skipping notification."
            exit 0
          fi

          CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          CREATED_DATE="$CURRENT_TIME"

          if [ -n "$DATE_FORMAT" ]; then
            TARGET_CAL="${DATE_FORMAT}"
            if [ "$DATE_FORMAT" == "both" ]; then
              TARGET_CAL="${CALENDAR_TYPE:-jalali}"
            fi

            TARGET_TIMEZONE="${TIMEZONE:-Asia/Tehran}"
            if [ "$TARGET_CAL" != "jalali" ] && [ "$TARGET_CAL" != "persian" ]; then
              TARGET_TIMEZONE="${TIMEZONE:-UTC}"
            fi

            CONVERTER_BIN=""
            if [ -f "vendor/bin/date-converter.sh" ]; then
              CONVERTER_BIN="vendor/bin/date-converter.sh"
            elif [ -f "vendor/jobmetric/multi-calendar/bin/date-converter.sh" ]; then
              CONVERTER_BIN="vendor/jobmetric/multi-calendar/bin/date-converter.sh"
            elif [ -f "vendor/bin/date-converter" ]; then
              CONVERTER_BIN="vendor/bin/date-converter"
            else
              CONVERTER_BIN=$(find vendor -name "date-converter.sh" -type f | head -n 1)
            fi

            if [ -n "$CONVERTER_BIN" ]; then
              DATE_TO_CONVERT="${CURRENT_TIME%Z}"
              DATE_TO_CONVERT="${DATE_TO_CONVERT%%+*}"

              set +e
              if [[ "$CONVERTER_BIN" == *.sh ]]; then
                CONVERTED=$(bash "$CONVERTER_BIN" "$DATE_TO_CONVERT" --date-format gregorian --format-input "Y-m-d\TH:i:s" --to "$TARGET_CAL" --format-output "Y-m-d H:i:s" --from-timezone UTC --to-timezone "$TARGET_TIMEZONE" 2>&1)
              else
                CONVERTED=$(php "$CONVERTER_BIN" "$DATE_TO_CONVERT" --date-format gregorian --format-input "Y-m-d\TH:i:s" --to "$TARGET_CAL" --format-output "Y-m-d H:i:s" --from-timezone UTC --to-timezone "$TARGET_TIMEZONE" 2>&1)
              fi
              EXIT_CODE=$?
              set -e

              if [ $EXIT_CODE -eq 0 ] && [ -n "$CONVERTED" ] && [[ ! "$CONVERTED" =~ "exec" ]] && [[ ! "$CONVERTED" =~ "Error" ]]; then
                CLEAN_DATE=$(echo "$CONVERTED" | tail -n1)
                if [ "$DATE_FORMAT" == "both" ]; then
                  CREATED_DATE="${CURRENT_TIME} / ${CLEAN_DATE} (${TARGET_TIMEZONE})"
                else
                  CREATED_DATE="${CLEAN_DATE} (${TARGET_TIMEZONE})"
                fi
              fi
            fi
          elif [ -n "$CURRENT_TIME" ]; then
            CREATED_DATE=$(date -d "$CURRENT_TIME" "+%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "$CURRENT_TIME")
          else
            CREATED_DATE="N/A"
          fi

          if [ "$EVENT_NAME" = "pull_request" ] && [ -n "${PR_NUMBER:-}" ]; then
            context_line="PR #${PR_NUMBER}"
          else
            context_line="Event: ${EVENT_NAME}"
          fi

          MESSAGE="❌ Package tests failed"$'\n'
          MESSAGE="${MESSAGE}Repository: <b><code>${REPOSITORY}</code></b>"$'\n'
          MESSAGE="${MESSAGE}Package: <b><code>${PACKAGE_NAME}</code></b>"$'\n'
          MESSAGE="${MESSAGE}${context_line}"$'\n'
          MESSAGE="${MESSAGE}Time: <b>${CREATED_DATE:-N/A}</b>"$'\n\n'
          MESSAGE="${MESSAGE}<a href=\"${RUN_URL}\">View Run on GitHub</a>"

          # Send message to Telegram and capture response
          echo "Sending notification to Telegram..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode "text=$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Telegram notification sent successfully"
            echo "Response: $BODY"
          else
            echo "❌ Failed to send Telegram notification"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Notify Telegram on success
        if: ${{ always() && steps.package_tests.outcome == 'success' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.bot_token }}
          TELEGRAM_CHAT_ID: ${{ secrets.chat_id }}
          PACKAGE_NAME: ${{ steps.package.outputs.name }}
          REPOSITORY: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EVENT_NAME: ${{ github.event_name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          DATE_FORMAT: ${{ inputs.date_format }}
          CALENDAR_TYPE: ${{ inputs.calendar_type }}
          TIMEZONE: ${{ inputs.timezone }}
        shell: bash
        run: |
          # Skip if credentials not set
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram credentials not set. Skipping notification."
            exit 0
          fi

          CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          CREATED_DATE="$CURRENT_TIME"

          if [ -n "$DATE_FORMAT" ]; then
            TARGET_CAL="${DATE_FORMAT}"
            if [ "$DATE_FORMAT" == "both" ]; then
              TARGET_CAL="${CALENDAR_TYPE:-jalali}"
            fi

            TARGET_TIMEZONE="${TIMEZONE:-Asia/Tehran}"
            if [ "$TARGET_CAL" != "jalali" ] && [ "$TARGET_CAL" != "persian" ]; then
              TARGET_TIMEZONE="${TIMEZONE:-UTC}"
            fi

            CONVERTER_BIN=""
            if [ -f "vendor/bin/date-converter.sh" ]; then
              CONVERTER_BIN="vendor/bin/date-converter.sh"
            elif [ -f "vendor/jobmetric/multi-calendar/bin/date-converter.sh" ]; then
              CONVERTER_BIN="vendor/jobmetric/multi-calendar/bin/date-converter.sh"
            elif [ -f "vendor/bin/date-converter" ]; then
              CONVERTER_BIN="vendor/bin/date-converter"
            else
              CONVERTER_BIN=$(find vendor -name "date-converter.sh" -type f | head -n 1)
            fi

            if [ -n "$CONVERTER_BIN" ]; then
              DATE_TO_CONVERT="${CURRENT_TIME%Z}"
              DATE_TO_CONVERT="${DATE_TO_CONVERT%%+*}"

              set +e
              if [[ "$CONVERTER_BIN" == *.sh ]]; then
                CONVERTED=$(bash "$CONVERTER_BIN" "$DATE_TO_CONVERT" --date-format gregorian --format-input "Y-m-d\TH:i:s" --to "$TARGET_CAL" --format-output "Y-m-d H:i:s" --from-timezone UTC --to-timezone "$TARGET_TIMEZONE" 2>&1)
              else
                CONVERTED=$(php "$CONVERTER_BIN" "$DATE_TO_CONVERT" --date-format gregorian --format-input "Y-m-d\TH:i:s" --to "$TARGET_CAL" --format-output "Y-m-d H:i:s" --from-timezone UTC --to-timezone "$TARGET_TIMEZONE" 2>&1)
              fi
              EXIT_CODE=$?
              set -e

              if [ $EXIT_CODE -eq 0 ] && [ -n "$CONVERTED" ] && [[ ! "$CONVERTED" =~ "exec" ]] && [[ ! "$CONVERTED" =~ "Error" ]]; then
                CLEAN_DATE=$(echo "$CONVERTED" | tail -n1)
                if [ "$DATE_FORMAT" == "both" ]; then
                  CREATED_DATE="${CURRENT_TIME} / ${CLEAN_DATE} (${TARGET_TIMEZONE})"
                else
                  CREATED_DATE="${CLEAN_DATE} (${TARGET_TIMEZONE})"
                fi
              fi
            fi
          elif [ -n "$CURRENT_TIME" ]; then
            CREATED_DATE=$(date -d "$CURRENT_TIME" "+%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "$CURRENT_TIME")
          else
            CREATED_DATE="N/A"
          fi

          if [ "$EVENT_NAME" = "pull_request" ] && [ -n "${PR_NUMBER:-}" ]; then
            context_line="PR #${PR_NUMBER}"
          else
            context_line="Event: ${EVENT_NAME}"
          fi

          MESSAGE="✅ Package tests passed"$'\n'
          MESSAGE="${MESSAGE}Repository: <b><code>${REPOSITORY}</code></b>"$'\n'
          MESSAGE="${MESSAGE}Package: <b><code>${PACKAGE_NAME}</code></b>"$'\n'
          MESSAGE="${MESSAGE}${context_line}"$'\n'
          MESSAGE="${MESSAGE}Time: <b>${CREATED_DATE:-N/A}</b>"$'\n\n'
          MESSAGE="${MESSAGE}<a href=\"${RUN_URL}\">View Run on GitHub</a>"

          # Send message to Telegram and capture response
          echo "Sending notification to Telegram..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode "text=$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Telegram notification sent successfully"
            echo "Response: $BODY"
          else
            echo "❌ Failed to send Telegram notification"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Fail workflow if tests failed
        if: ${{ steps.package_tests.outcome == 'failure' }}
        run: exit 1
